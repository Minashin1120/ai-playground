<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Playground (V2.7.2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #111827; color: #f3f4f6; }
        .prose { font-size: 0.95rem; line-height: 1.7; color: #e5e7eb; max-width: none; }
        .prose pre { background: #0f1117 !important; padding: 1em; overflow-x: auto; border-radius: 0.5em; border: 1px solid #374151; }
        .prose code { color: #e5e7eb !important; background: transparent !important; }
        .thought-box { border-left: 3px solid #a855f7; background: #1f2937; padding: 0.75rem; font-size: 0.85rem; color: #d8b4fe; border-radius: 0.25rem; white-space: pre-wrap; word-break: break-word; overflow-y: auto; max-height: 300px; font-family: monospace; margin-bottom: 1em; }
        .message-bubble { max-width: 90%; position: relative; }
        @media (min-width: 768px) { .message-bubble { max-width: 80%; } }
        .ctrl-btn { background: #1f2937; color: #9ca3af; border: 1px solid #4b5563; border-radius: 4px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; }
        .msg-controls { opacity: 0; transition: opacity 0.2s; position: absolute; top: -12px; right: 0; display: flex; gap: 4px; }
        .message-group:hover .msg-controls { opacity: 1; }
        @media (max-width: 768px) { .sidebar { position: fixed; z-index: 50; height: 100%; transform: translateX(-100%); transition: transform 0.3s; } .sidebar.open { transform: translateX(0); } .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; } .overlay.active { display: block; } }
        .gem-item.active { background-color: #374151; border-left: 3px solid #3b82f6; }
    </style>
</head>
<body class="h-[100dvh] flex overflow-hidden text-sm md:text-base">

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar w-64 bg-gray-800 border-r border-gray-700 flex flex-col shrink-0">
        <div class="p-3 border-b border-gray-700 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <h2 class="font-bold text-base flex-shrink-0 text-gray-200">AI Chat</h2>
                <div class="flex items-center gap-1">
                    <button onclick="location.href='/changelog'" class="text-gray-400 hover:text-white p-1.5 rounded" title="履歴"><i class="fas fa-history text-xs"></i></button>
                    <button id="settings-btn" class="text-gray-400 hover:text-green-400 p-1.5 rounded" title="設定"><i class="fas fa-cog text-xs"></i></button>
                    <button id="lib-btn" class="text-gray-400 hover:text-blue-400 p-1.5 rounded" title="ライブラリ"><i class="fas fa-folder text-xs"></i></button>
                    <button id="new-chat-btn" class="text-gray-400 hover:text-white p-1.5 rounded bg-blue-600 hover:bg-blue-500" title="新規チャット"><i class="fas fa-plus text-xs"></i></button>
                </div>
            </div>
            <div class="relative"><input type="text" id="search-box" placeholder="検索..." class="w-full bg-gray-700 rounded px-3 py-1 text-sm"><i class="fas fa-search absolute right-3 top-1.5 text-gray-500 text-xs"></i></div>
        </div>

        <!-- Gems Section -->
        <div class="px-2 py-2">
            <div class="flex justify-between items-center px-2 mb-1">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Gems</span>
                <button id="add-gem-btn" class="text-xs text-blue-400 hover:text-blue-300"><i class="fas fa-plus"></i> New</button>
            </div>
            <div id="gem-list" class="space-y-1 overflow-y-auto max-h-40"></div>
        </div>
        
        <div class="border-t border-gray-700 my-1"></div>

        <div class="px-2 mb-1"><span class="text-xs font-bold text-gray-400 uppercase tracking-wider">History</span></div>
        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="thread-list"></div>
        
        <div class="p-3 border-t border-gray-700 text-center text-xs text-gray-500">
            <div>v2.7.2 <span class="text-orange-500 font-bold">BETA</span></div>
            <a href="/logout" class="block mt-2 hover:text-white">ログアウト</a>
        </div>
    </div>
    
    <div id="overlay" class="overlay"></div>

    <div class="flex-1 flex flex-col w-full relative min-w-0">
        <header class="bg-gray-800 border-b border-gray-700 p-3 shadow-md flex justify-between items-center shrink-0 md:hidden">
            <button id="menu-btn" class="text-gray-300 p-2"><i class="fas fa-bars text-xl"></i></button>
            <span class="font-bold text-sm" id="header-title">AI Playground</span>
            <button id="mobile-new-chat-btn" class="text-blue-400 font-bold text-xl p-2">+</button>
        </header>

        <div class="flex-1 overflow-hidden relative">
            <div id="chat-container" class="absolute inset-0 overflow-y-auto p-4 space-y-6 scroll-smooth"></div>
            <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 space-y-4 bg-[#111827] z-10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2"><i class="fas fa-gem text-blue-500"></i> AI Gems & Chat</h2>
                <p class="text-sm">Gemsを作成して、専門家AIとチャットしましょう。</p>
            </div>
        </div>

        <div class="bg-gray-800 border-t border-gray-700 p-3 shrink-0 z-10">
            <div class="max-w-3xl mx-auto space-y-2 relative">
                <div id="gem-active-indicator" class="hidden absolute -top-10 left-0 bg-blue-900/80 text-blue-200 text-xs px-3 py-1 rounded-t-lg border-t border-l border-r border-blue-700 flex items-center gap-2">
                    <i class="fas fa-gem"></i> Using Gem: <span id="active-gem-name" class="font-bold"></span>
                    <button onclick="clearActiveGem()" class="ml-2 hover:text-white">×</button>
                </div>
                
                <div id="stop-container" class="absolute -top-12 left-1/2 transform -translate-x-1/2 hidden">
                    <button id="stop-btn" class="bg-red-500/90 hover:bg-red-600 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 text-sm backdrop-blur-sm"><i class="fas fa-stop"></i> 停止</button>
                </div>

                <div class="flex flex-wrap justify-between items-center text-xs text-gray-400 gap-2">
                    <!-- 完全なモデルリスト -->
                    <select id="model-select" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 outline-none text-white max-w-[200px] truncate">
                        <optgroup label="Gemini">
                            <option value="gemini-3.0-pro-preview">Gemini 3.0 Pro</option>
                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        </optgroup>
                        <optgroup label="GPT">
                            <option value="gpt-5.1">GPT-5.1</option>
                            <option value="gpt-5-mini">GPT-5 mini</option>
                        </optgroup>
                        <optgroup label="xAI Grok">
                            <option value="grok-4-1-fast-reasoning">Grok 4.1 Fast (Reasoning)</option>
                            <option value="grok-4-1-fast-non-reasoning">Grok 4.1 Fast (Non-Reasoning)</option>
                            <option value="grok-4-fast-reasoning">Grok 4 Fast (Reasoning)</option>
                            <option value="grok-4-fast-non-reasoning">Grok 4 Fast (Non-Reasoning)</option>
                        </optgroup>
                        <optgroup label="Image">
                            <option value="nano-banana">Nano Banana</option>
                            <option value="nano-banana-pro">Nano Banana Pro</option>
                        </optgroup>
                    </select>

                    <div class="flex gap-3 items-center flex-wrap">
                        <label class="flex items-center space-x-1 cursor-pointer select-none"><input type="checkbox" id="enable-search" class="accent-blue-500 w-3 h-3"><span>Search</span></label>
                        <label id="sys-prompt-option" class="flex items-center space-x-1 cursor-pointer select-none"><input type="checkbox" id="enable-sys-prompt" class="accent-green-500 w-3 h-3"><span class="text-green-300">SysPrompt</span></label>
                        <!-- Thinking & Effort (復元) -->
                        <label id="thinking-option" class="flex items-center space-x-1 cursor-pointer hidden select-none"><input type="checkbox" id="enable-thinking" class="accent-purple-500 w-3 h-3"><span class="text-purple-300">Thinking</span></label>
                        <div id="reasoning-effort-container" class="hidden flex items-center gap-1"><span class="text-gray-400">Effort:</span><select id="reasoning-effort" class="bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-xs text-white outline-none"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
                    </div>
                </div>
                
                <div id="file-preview" class="hidden px-3 py-2 bg-gray-700/50 rounded text-xs text-blue-300 flex justify-between items-center"><span id="file-name" class="truncate"></span><button id="clear-file-btn" class="text-gray-400 hover:text-white ml-2">✕</button></div>
                
                <div class="flex gap-2 items-end">
                    <input type="file" id="file-input" class="hidden" multiple>
                    <button id="upload-btn" class="bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-gray-300 transition shrink-0"><i class="fas fa-paperclip"></i></button>
                    <textarea id="prompt-input" rows="1" class="flex-1 bg-gray-700 border-none rounded-lg p-3 focus:ring-1 focus:ring-blue-500 outline-none resize-none text-white transition text-sm sm:text-base" placeholder="Ctrl + Enter で送信..." style="min-height: 46px; max-height: 150px;"></textarea>
                    <button id="send-btn" class="bg-blue-600 hover:bg-blue-500 p-3 rounded-lg text-white font-bold disabled:opacity-50 transition shadow-lg w-12 flex justify-center items-center shrink-0"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="text-[10px] text-gray-500 text-right hidden md:block">Send: <span class="text-gray-300 font-mono">Ctrl + Enter</span></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="gem-modal" class="fixed inset-0 bg-gray-900/95 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-800 rounded-lg w-full max-w-lg p-6 shadow-2xl border border-gray-700 m-4 flex flex-col max-h-[90vh]">
            <h2 class="text-xl font-bold text-white mb-4"><i class="fas fa-gem text-blue-500 mr-2"></i>Create New Gem</h2>
            <div class="space-y-4 flex-1 overflow-y-auto">
                <div><label class="text-xs text-gray-500 block mb-1">Gem Name</label><input type="text" id="gem-name" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white text-sm" placeholder="e.g. Code Reviewer"></div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Instructions (System Prompt)</label>
                    <textarea id="gem-instruction" class="w-full h-40 bg-gray-900 border border-gray-600 rounded p-2 text-white text-sm" placeholder="You are an expert in..."></textarea>
                    <p class="text-xs text-gray-500 mt-1">このGemがどのように振る舞うべきかを記述します。</p>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="document.getElementById('gem-modal').style.display='none'" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button id="save-gem-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded font-bold">Create Gem</button>
            </div>
        </div>
    </div>

    <div id="lib-modal" class="fixed inset-0 bg-gray-900/95 z-50 flex flex-col backdrop-blur-sm" style="display:none;">
        <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800 shadow-lg shrink-0"><h2 class="text-xl font-bold text-white">ライブラリ</h2><button onclick="document.getElementById('lib-modal').style.display='none'" class="text-gray-400 w-8 h-8 rounded-full hover:bg-gray-700">✕</button></div>
        <div class="p-2 border-b border-gray-700 bg-gray-800/50 flex justify-between items-center shrink-0"><span id="lib-total-count" class="text-xs text-gray-400 px-2">0 files</span><button id="lib-del-btn" class="bg-red-600 text-white px-4 py-1.5 rounded text-xs" disabled>削除</button></div>
        <div id="lib-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-3 gap-4"></div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-gray-900/95 z-50 hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-800 rounded-lg w-full max-w-2xl p-6 shadow-2xl border border-gray-700">
             <h2 class="text-xl font-bold text-white mb-4">設定</h2>
             <div class="flex justify-end"><button onclick="document.getElementById('settings-modal').style.display='none'" class="text-gray-400">閉じる</button></div>
        </div>
    </div>

    <script>
        const get = (id) => document.getElementById(id);
        let currentThreadId = null, activeGem = null, currentImageUrls = [], abortController = null;

        function escapeHtml(text) {
            if (!text) return text;
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadThreads(); loadGems();
            toggleOptions(); // 初期設定の反映

            get('new-chat-btn').onclick = () => startNewChat();
            get('mobile-new-chat-btn').onclick = () => startNewChat();
            get('send-btn').onclick = sendMessage;
            get('add-gem-btn').onclick = () => get('gem-modal').style.display='flex';
            get('save-gem-btn').onclick = createGem;
            get('prompt-input').onkeydown = (e) => {
                if (e.isComposing) return;
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); get('send-btn').click(); }
            };
            get('lib-btn').onclick = () => { get('lib-modal').style.display='flex'; loadLibraryFiles(); };
            get('upload-btn').onclick = () => get('file-input').click();
            get('file-input').onchange = (e) => handleFiles(e.target.files);
            get('menu-btn').onclick = () => { get('sidebar').classList.toggle('open'); get('overlay').classList.toggle('active'); };
            get('overlay').onclick = () => { get('sidebar').classList.remove('open'); get('overlay').classList.remove('active'); };
            
            // モデル変更時にオプションを切り替え
            get('model-select').addEventListener('change', toggleOptions);
        });

        // オプション表示切り替えロジックの復元
        function toggleOptions() {
            const model = get('model-select').value;
            const think = get('thinking-option');
            const reason = get('reasoning-effort-container');
            const search = get('search-container');

            // 一旦すべて隠す
            if(think) think.classList.add('hidden');
            if(reason) reason.classList.add('hidden');
            
            // モデル名に応じた表示制御
            if(model.includes('gemini') || model.includes('nano')) {
                // GeminiとNano系でThinkingを表示
                if(think) think.classList.remove('hidden');
            } else if(model.includes('gpt')) {
                // GPT系でEffortを表示
                if(reason) reason.classList.remove('hidden');
            }
            // Grok系はSearchのみ（デフォルトで表示）
        }

        async function loadGems() {
            try {
                const res = await fetch('/api/gems');
                const gems = await res.json();
                const list = get('gem-list'); list.innerHTML = '';
                gems.forEach(g => {
                    const div = document.createElement('div');
                    div.className = 'gem-item p-2 rounded hover:bg-gray-700 cursor-pointer text-sm text-gray-300 flex justify-between items-center group';
                    div.innerHTML = `<div class="flex items-center gap-2 overflow-hidden"><i class="fas fa-gem text-blue-500"></i><span class="truncate">${g.name}</span></div><button class="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 px-2" onclick="deleteGem(event, ${g.id})">×</button>`;
                    div.onclick = (e) => { if(e.target.tagName!=='BUTTON') activateGem(g); };
                    list.appendChild(div);
                });
            } catch(e) {}
        }
        async function createGem() {
            const name = get('gem-name').value;
            const instruction = get('gem-instruction').value;
            if(!name || !instruction) return alert("Required");
            await fetch('/api/gems', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({name, instruction})});
            get('gem-modal').style.display='none'; get('gem-name').value=''; get('gem-instruction').value='';
            loadGems();
        }
        async function deleteGem(e, id) {
            e.stopPropagation();
            if(!confirm("Delete?")) return;
            await fetch('/api/gems/' + id, {method: 'DELETE'});
            loadGems();
            if(activeGem && activeGem.id === id) clearActiveGem();
        }
        function activateGem(gem) {
            activeGem = gem;
            get('active-gem-name').innerText = gem.name;
            get('gem-active-indicator').classList.remove('hidden');
            currentThreadId = null; get('chat-container').innerHTML = ''; get('welcome-screen').classList.add('hidden');
            get('sys-prompt-option').style.opacity = '0.5';
            if(window.innerWidth < 768) get('overlay').click();
        }
        function clearActiveGem() {
            activeGem = null;
            get('gem-active-indicator').classList.add('hidden');
            get('sys-prompt-option').style.opacity = '1';
        }
        function startNewChat() {
            currentThreadId = null; clearActiveGem(); get('chat-container').innerHTML = ''; get('welcome-screen').classList.remove('hidden'); loadThreads();
            if(window.innerWidth < 768) get('overlay').click();
        }
        async function loadThreads() {
            const res = await fetch('/api/threads');
            const threads = await res.json();
            const list = get('thread-list'); list.innerHTML = '';
            threads.forEach(t => {
                const d = document.createElement('div');
                d.className = 'p-2 rounded hover:bg-gray-700 cursor-pointer text-sm text-gray-300 border-b border-gray-700/30 truncate';
                d.innerText = t.title || "No Title"; d.onclick = () => loadMessages(t.id);
                list.appendChild(d);
            });
        }
        async function loadMessages(tid) {
            currentThreadId = tid; clearActiveGem(); get('welcome-screen').classList.add('hidden');
            get('chat-container').innerHTML = '<div class="text-center mt-10"><i class="fas fa-spinner fa-spin text-blue-500"></i></div>';
            const res = await fetch('/api/threads/' + tid);
            const msgs = await res.json(); get('chat-container').innerHTML = '';
            msgs.forEach(m => renderMessage(m));
            if(window.innerWidth < 768) get('overlay').click();
        }
        async function sendMessage() {
            const text = get('prompt-input').value.trim();
            if(!text && currentImageUrls.length === 0) return;
            if(!currentThreadId) { const res = await fetch('/api/threads', {method: 'POST'}); const d = await res.json(); currentThreadId = d.id; }
            get('welcome-screen').classList.add('hidden');
            renderMessage({role: 'user', content: text, image_url: JSON.stringify(currentImageUrls)});
            get('prompt-input').value = '';
            const payload = { thread_id: currentThreadId, message: text, model: get('model-select').value, image_urls: currentImageUrls, enable_search: get('enable-search').checked, enable_thinking: get('enable-thinking').checked, reasoning_effort: get('reasoning-effort').value, enable_system_prompt: get('enable-sys-prompt').checked };
            if (activeGem) { payload.system_prompt = activeGem.instruction; payload.enable_system_prompt = true; }
            currentImageUrls = []; get('file-preview').classList.add('hidden'); get('send-btn').disabled = true;
            
            const aiDivId = 'ai-' + Date.now();
            get('chat-container').insertAdjacentHTML('beforeend', `<div id="${aiDivId}" class="message-bubble bg-gray-700 text-white p-4 rounded-2xl rounded-tl-none mb-4"><span class="animate-pulse">Thinking...</span></div>`);
            
            try {
                const res = await fetch('/chat_stream', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                const aiDiv = document.getElementById(aiDivId);
                aiDiv.innerHTML = '';
                
                let buffer = "";
                let accumulatedText = "";
                let thoughtText = "";
                
                while(true) {
                    const {done, value} = await reader.read();
                    if(done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    let lines = buffer.split("\n");
                    buffer = lines.pop();
                    
                    for(let line of lines) {
                        if(!line.trim()) continue;
                        try {
                            const json = JSON.parse(line);
                            if (json.type === 'content') {
                                accumulatedText += json.data;
                                let html = marked.parse(accumulatedText);
                                if (thoughtText) {
                                    html = `<div class="thought-box">${escapeHtml(thoughtText)}</div>` + html;
                                }
                                aiDiv.innerHTML = html;
                            } else if (json.type === 'thought') {
                                thoughtText += json.data;
                                let html = marked.parse(accumulatedText);
                                html = `<div class="thought-box">${escapeHtml(thoughtText)}</div>` + html;
                                aiDiv.innerHTML = html;
                            } else if (json.type === 'error') {
                                aiDiv.innerHTML += `<div class="text-red-400">Error: ${escapeHtml(json.data)}</div>`;
                            }
                        } catch(e) {}
                    }
                    get('chat-container').scrollTop = get('chat-container').scrollHeight;
                }
                loadThreads();
            } catch(e) { 
                document.getElementById(aiDivId).innerHTML = '<span class="text-red-400">Connection Error</span>'; 
            } finally { 
                get('send-btn').disabled = false; 
            }
        }
        function renderMessage(m) {
            const isUser = m.role === 'user';
            const div = document.createElement('div');
            div.className = `flex ${isUser?'justify-end':'justify-start'} mb-4`;
            
            let contentHtml = "";
            if (m.thought_data && !isUser) {
                try {
                    const tData = JSON.parse(m.thought_data);
                    const tText = tData.text || "";
                    if (tText) contentHtml += `<div class="thought-box">${escapeHtml(tText)}</div>`;
                } catch(e) {}
            }
            contentHtml += m.content ? marked.parse(m.content) : '';
            div.innerHTML = `<div class="message-bubble ${isUser?'bg-blue-600 rounded-tr-none':'bg-gray-700 rounded-tl-none'} text-white p-4 rounded-2xl shadow-md prose prose-invert">${contentHtml}</div>`;
            get('chat-container').appendChild(div);
            get('chat-container').scrollTop = get('chat-container').scrollHeight;
        }
        async function handleFiles(files) {
            if(!files.length) return;
            get('file-preview').classList.remove('hidden'); get('file-name').innerText = "Uploading...";
            for(let f of files) { const fd = new FormData(); fd.append('file', f); const r = await fetch('/upload', {method:'POST', body:fd}); const d = await r.json(); if(d.filename) currentImageUrls.push(d.filename); }
            get('file-name').innerText = `${currentImageUrls.length} files`; get('file-input').value = '';
        }
        get('clear-file-btn').onclick = () => { currentImageUrls=[]; get('file-preview').classList.add('hidden'); };
        async function loadLibraryFiles() {
            const r = await fetch('/api/files'); const files = await r.json();
            const grid = get('lib-grid'); grid.innerHTML = ''; get('lib-total-count').innerText = files.length + " files";
            files.forEach(f => {
                const el = document.createElement('div');
                el.className = "bg-gray-700 h-24 rounded flex items-center justify-center border border-gray-600";
                el.innerHTML = f.type==='image' ? `<img src="${f.url}" class="h-full w-full object-cover">` : `<span class="text-xs">${f.filename}</span>`;
                grid.appendChild(el);
            });
        }
    </script>
</body>
</html>